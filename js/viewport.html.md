# JS: Viewport Height


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## generate_viewport_height_js

Sets explicit pixel height on the card stack to fill available vertical
space.

**Algorithm:** 1. Temporarily collapse card stack to measure natural
positions 2. `spaceAbove` — Visual distance from container top to card
stack top (position-based) 3. `spaceBelow` — Visual distance from card
stack bottom to container bottom + space below container 4.
`viewportHeight = windowHeight - spaceAbove - spaceBelow`

**Key design decisions:** - **Position-based measurement** — Measures
actual visual positions, not computed margins. Handles margin
collapsing, flex gap, grid gap, etc. automatically. - **Temporary
collapse** — Card stack is briefly set to 0px height to measure its
natural top position, then restored. - **Sibling-agnostic** — Doesn’t
care about individual siblings; measures aggregate space above and
below. - **Debug mode** — Set `window.cardStackDebug = true` to log all
intermediate values

The `container_id` parameter is the consumer’s parent container that
holds the card stack alongside header/footer elements. If not provided,
the card stack measures from its own position.

------------------------------------------------------------------------

<a
href="https://github.com/cj-mills/cjm-fasthtml-card-stack/blob/main/cjm_fasthtml_card_stack/js/viewport.py#L12"
target="_blank" style="float:right; font-size:smaller">source</a>

### generate_viewport_height_js

``` python

def generate_viewport_height_js(
    ids:CardStackHtmlIds, # HTML IDs for this card stack instance
    container_id:str='', # Consumer's parent container ID (empty = use card stack parent)
)->str: # JavaScript code fragment for viewport height calculation

```

*Generate JS for dynamic viewport height calculation.*

Uses position-based measurement to determine available space.
Temporarily collapses the card stack to measure its natural top
position, then calculates available height based on actual visual
positions.

This approach handles margin collapsing, flex gap, grid gap, and any
other CSS layout mechanism automatically.

Debug mode: Set `window.cardStackDebug = true` in browser console to log
all intermediate calculation values.

``` python
# Test that the generator produces valid JS referencing correct IDs
ids = CardStackHtmlIds(prefix="cs0")
js = generate_viewport_height_js(ids, container_id="my-container")
assert "my-container" in js
assert ids.card_stack in js
assert ids.card_stack_inner in js
assert "ns.recalculateHeight" in js
assert "calculateAndSetViewportHeight" in js

# Verify position-based measurement approach
assert "spaceAbove" in js
assert "spaceBelow" in js
assert "calculateSpaceBelowCardStack" in js

# Verify temporary collapse approach for accurate measurement
assert "height = '0px'" in js
assert "minHeight = '0px'" in js
assert "offsetHeight" in js  # Force reflow

# Verify position-based sibling detection (beside vs below)
assert "siblingRect.top < currentRect.bottom" in js

# Verify debug mode
assert "window.cardStackDebug" in js
assert f"[{ids.prefix}]" in js  # debug log prefix

# Verify auto-adjust trigger in resize handler
assert "ns.triggerAutoAdjust" in js

# Verify resize listener uses remove-and-replace (not guard-and-skip)
handler_key = f"_csResizeHandler_{ids.prefix.replace('-', '_')}"
assert f"window.{handler_key}" in js
assert "removeEventListener" in js

print("Viewport height JS generator tests passed!")
```

    Viewport height JS generator tests passed!

``` python
# Test without container_id (falls back to parent element with null guard)
js_no_container = generate_viewport_height_js(ids)
assert ".parentElement" in js_no_container
# Verify null guard exists before .parentElement access
assert "if (!_csEl) return 400" in js_no_container
# Verify position-based measurement is present in both paths
assert "spaceAbove" in js_no_container
assert "calculateSpaceBelowCardStack" in js_no_container
print("Viewport height JS fallback container test passed!")
```

    Viewport height JS fallback container test passed!
